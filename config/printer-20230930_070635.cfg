## Voron Design VORON2.4  300mm  MKS Monster8 V1.0 TMC2209 UART config
[include MACHINE/machine.cfg]
[include MACHINE/macros.cfg]
[include MACHINE/neopixels.cfg]
[include MACHINE/nozzle_scrub.cfg]
[include MACHINE/bedfans.cfg]
#[include klipperExpander.cfg]
[include KAMP/*cfg]
#[include MACHINE/*cfg]


[pause_resume]

[display_status]

[respond]

[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT


[exclude_object]


[force_move]
enable_force_move: True



#####################################################################
#	MCU
#####################################################################

#	MCU
[mcu]
canbus_uuid: 0ee53ec05d88


#	MCU EBBCan
[mcu EBBCan]
canbus_uuid: 5ee53906b31d


#####################################################################
#	Temperature
#####################################################################

#	Raspberry Pi
[temperature_sensor raspberry_pi]
sensor_type:        temperature_host
min_temp:                       0
max_temp:                       80


#	EBB NTC
[temperature_sensor EBB_NTC]
sensor_type: Generic 3950
sensor_pin: EBBCan: PA2


#####################################################################
#	Input Shaper
#####################################################################

[input_shaper]
#shaper_freq_x: 46.0
#shaper_type_x: zv
#shaper_freq_y: 28.8
#shaper_type_y: mzv


[adxl345]
cs_pin: EBBCan: PB12
spi_software_sclk_pin: EBBCan: PB10
spi_software_mosi_pin: EBBCan: PB11
spi_software_miso_pin: EBBCan: PB2
axes_map: z,-y,x


[resonance_tester]
probe_points: 150, 150, 20
accel_chip: adxl345


#####################################################################
#	Printer
#####################################################################
[printer]
kinematics: corexy
max_velocity: 600  
max_accel: 10000   			#Max 4000
max_z_velocity: 30			#Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 8.0
max_accel_to_decel: 5000


#####################################################################
#      X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin:PC14
dir_pin:PC13
enable_pin:!PC15
microsteps: 32
rotation_distance: 40
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: EBBCan: PB6
position_min: 0  
position_endstop: 300
position_max: 300

homing_speed:50
homing_retract_dist:5
homing_positive_dir:true


#--------------------------------------------------------------------
[stepper_y]
step_pin:PE5
dir_pin:PE4
enable_pin:!PC15
microsteps: 32
rotation_distance: 40
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:PA15
position_min: 0
position_endstop: 300
position_max: 300

homing_speed:50
homing_retract_dist:5
homing_positive_dir:true



## TMC UART configuration--------------------------------------------------------------------
[tmc2209 stepper_x]
uart_pin: PE6
interpolate: False
run_current: 0.75
#hold_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 0


#--------------------------------------------------------------------
[tmc2209 stepper_y]
uart_pin: PE3
interpolate: False
run_current: 0.75
#hold_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 0
#--------------------------------------------------------------------


#####################################################################
#   Z Stepper Settings
#####################################################################
[stepper_z]
step_pin: PD13
dir_pin: PD12
enable_pin: !PD14
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 200
gear_ratio: 80:16
endstop_pin:probe:z_virtual_endstop ## PB12 for Z-max; endstop have'!' is NO

position_max: 250
position_min: -15 
homing_speed: 8
second_homing_speed: 3


#--------------------------------------------------------------------
[stepper_z1]
step_pin:PD6
dir_pin:!PD5
enable_pin:!PD7
microsteps:16
rotation_distance: 40
full_steps_per_rotation: 200
gear_ratio: 80:16


#--------------------------------------------------------------------
[stepper_z2]
step_pin:PD2
dir_pin:PD1
enable_pin:!PD3
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 200
gear_ratio: 80:16


#--------------------------------------------------------------------
[stepper_z3]
step_pin:PC7
dir_pin:!PC6
enable_pin:!PC8
microsteps:16
rotation_distance:40
full_steps_per_rotation: 200
gear_ratio:80:16


## TMC UART configuration--------------------------------------------------------------------
[tmc2208 stepper_z]
uart_pin: PD11
interpolate: False
run_current: 0.4
#hold_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 999999
#--------------------------------------------------------------------
[tmc2208 stepper_z1]
uart_pin: PD4
interpolate: False
run_current: 0.4
sense_resistor: 0.110
#hold_current: 0.5
stealthchop_threshold: 999999
#--------------------------------------------------------------------
[tmc2208 stepper_z2]
uart_pin: PD0
interpolate: False
run_current: 0.4
#hold_current: 0.
sense_resistor: 0.110
stealthchop_threshold: 999999
#--------------------------------------------------------------------
[tmc2208 stepper_z3]
uart_pin: PD15
interpolate: False
run_current: 0.4
#hold_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 999999
#--------------------------------------------------------------------




#####################################################################
#   Extruder
#####################################################################

[extruder]
step_pin: EBBCan: PD0
dir_pin: EBBCan: PD1
enable_pin: !EBBCan: PD2
microsteps: 128

##  Update value below when you perform extruder calibration
##  If you ask for 100mm of filament, but in reality it is 98mm:
##  rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100
##  22.6789511 is a good starting point
#rotation_distance: 22.0959333333	#Bondtech 5mm Drive Gears

rotation_distance: 21.89265074663
gear_ratio: 50:10
full_steps_per_rotation: 200	#200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.750
min_temp: 0
max_temp: 310
min_extrude_temp: 27
heater_pin: EBBCan: PB13
sensor_pin: EBBCan: PA3
sensor_type:  Generic 3950
max_power: 1.0

## PID Tuning
#control : pid  
#pid_kp : 26.213 
#pid_ki : 1.304
#pid_kd : 131.721 

##  Try to keep pressure_advance below 1.0
#pressure_advance: 0.05 
pressure_advance: 0.04
##  Default is 0.040, leave stock
pressure_advance_smooth_time: 0.020
max_extrude_only_distance: 1000.0
max_extrude_cross_section: 5


## TMC UART configuration--------------------------------------------------------------------
[tmc2209 extruder]
uart_pin: EBBCan: PA15
interpolate: False
run_current: 0.35
#hold_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 0
#--------------------------------------------------------------------


[heater_bed]
heater_pin: PB10
sensor_type: Generic 3950
sensor_pin: PC0

## PID Tuning
#control: pid
#pid_Kp: 42.066
#pid_Ki: 1.659
#pid_Kd: 266.595

max_power: 0.65
min_temp: 0
max_temp: 120

#####################################################################
# 	Probe
#####################################################################
[probe]
pin: ^EBBCan:  PB5
x_offset: 0
y_offset: 0
#z_offset: 0
speed: 4                     ; probing speed of 5mm/second ideal is <10mm/sec  
#lift_speed: 5              ; probe lift speed (was10)
samples: 1
samples_result: median
sample_retract_dist: 0.7
samples_tolerance: 0.05
samples_tolerance_retries: 3

activate_gcode:
    {% set PROBE_TEMP = 150 %}
    {% set MAX_TEMP = PROBE_TEMP + 5 %}
    {% set ACTUAL_TEMP = printer.extruder.temperature %}
    {% set TARGET_TEMP = printer.extruder.target %}

    {% if TARGET_TEMP > PROBE_TEMP %}
        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
        M109 S{ PROBE_TEMP }
    {% else %}
        # Temperature target is already low enough, but nozzle may still be too hot.
        {% if ACTUAL_TEMP > MAX_TEMP %}
            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
        {% endif %}
    {% endif %} 



#####################################################################
#	Save Config
#####################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 18.815
#*# pid_ki = 0.853
#*# pid_kd = 103.721
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 34.627
#*# pid_ki = 1.297
#*# pid_kd = 231.133
#*#
#*# [probe]
#*# z_offset = -1.105
#*#
#*# [input_shaper]
#*# shaper_type_x = ei
#*# shaper_freq_x = 43.6
#*# shaper_type_y = mzv
#*# shaper_freq_y = 28.4
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.031224, 0.016276, -0.001224, -0.046224, -0.076224
#*# 	-0.036224, -0.018724, -0.003724, -0.046224, -0.096224
#*# 	-0.081224, -0.031224, -0.003724, -0.066224, -0.113724
#*# 	-0.043724, 0.003776, 0.006276, -0.038724, -0.076224
#*# 	-0.028724, 0.026276, 0.026276, -0.006224, -0.046224
#*# 	-0.003724, 0.041276, 0.048776, 0.021276, -0.041224
#*# x_count = 5
#*# y_count = 6
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 78.15
#*# max_x = 221.83
#*# min_y = 72.6
#*# max_y = 227.4
