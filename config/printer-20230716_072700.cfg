## Voron Design VORON2.4  300mm  MKS Monster8 V1.0 TMC2209 UART config
[include MACHINE/machine.cfg]
[include MACHINE/macros.cfg]
[include MACHINE/neopixels.cfg]
[include MACHINE/nozzle_scrub.cfg]
#[include klipperExpander.cfg]
[include KAMP/*cfg]
#[include MACHINE/*cfg]

[pause_resume]

[display_status]

[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[exclude_object]

[force_move]
enable_force_move: True

#####################################################################
#	MCU
[mcu]
## Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
canbus_uuid: 0ee53ec05d88
#serial: /dev/serial/by-id/usb-Klipper_stm32f407xx_2A001B001051313130363733-if00
#restart_method: command

[mcu EBBCan]
canbus_uuid: 5ee53906b31d


[input_shaper]
#shaper_freq_x: 46.0
#shaper_type_x: zv
#shaper_freq_y: 28.8
#shaper_type_y: mzv

#####################################################################
#	Raspberry Pi
#####################################################################
[temperature_sensor raspberry_pi]
sensor_type:        temperature_host
min_temp:                       0
max_temp:                       80

[temperature_sensor EBB_NTC]
sensor_type: Generic 3950
sensor_pin: EBBCan: PA2

[adxl345]
cs_pin: EBBCan: PB12
spi_software_sclk_pin: EBBCan: PB10
spi_software_mosi_pin: EBBCan: PB11
spi_software_miso_pin: EBBCan: PB2
axes_map: z,-y,x

[resonance_tester]
probe_points: 150, 150, 20
accel_chip: adxl345
#####################################################################
#	Printer
#####################################################################
[printer]
kinematics: corexy
max_velocity: 300  
max_accel: 2000   			#Max 4000
max_z_velocity: 15 			#Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 300
square_corner_velocity: 5.0

#####################################################################
#      X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin:PC14
dir_pin:!PC13
enable_pin:!PC15
microsteps: 256
rotation_distance: 40
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
#endstop_pin:PA14
endstop_pin: EBBCan: PB5
position_min: 0  
position_endstop: 300
position_max: 300

homing_speed:50
homing_retract_dist:5
homing_positive_dir:true

#--------------------------------------------------------------------
[stepper_y]
step_pin:PE5
dir_pin:!PE4
enable_pin:!PC15
microsteps: 256
rotation_distance: 40
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:PA15
position_min: 0
position_endstop: 300
position_max: 300

homing_speed:50
homing_retract_dist:5
homing_positive_dir:true

## TMC UART configuration--------------------------------------------------------------------
[tmc2209 stepper_x]
uart_pin: PE6
interpolate: False
run_current: 0.7
#hold_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 0
#--------------------------------------------------------------------
[tmc2209 stepper_y]
uart_pin: PE3
interpolate: False
run_current: 0.7
#hold_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 0
#--------------------------------------------------------------------

#####################################################################
#   Z Stepper Settings
#####################################################################
[stepper_z]
step_pin: PD13
dir_pin: PD12
enable_pin: !PD14
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 200
gear_ratio: 80:16
endstop_pin:probe:z_virtual_endstop ## PB12 for Z-max; endstop have'!' is NO

position_max: 250
position_min: -15 
homing_speed: 8
second_homing_speed: 3
#--------------------------------------------------------------------
[stepper_z1]
step_pin:PD6
dir_pin:!PD5
enable_pin:!PD7
microsteps:16
rotation_distance: 40
full_steps_per_rotation: 200
gear_ratio: 80:16
#--------------------------------------------------------------------
[stepper_z2]
step_pin:PD2
dir_pin:PD1
enable_pin:!PD3
microsteps: 16
rotation_distance: 40
full_steps_per_rotation: 200
gear_ratio: 80:16
#--------------------------------------------------------------------
[stepper_z3]
step_pin:PC7
dir_pin:!PC6
enable_pin:!PC8
microsteps:16
rotation_distance:40
full_steps_per_rotation: 200
gear_ratio:80:16


## TMC UART configuration--------------------------------------------------------------------
[tmc2208 stepper_z]
uart_pin: PD11
interpolate: False
run_current: 0.4
#hold_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 999999
#--------------------------------------------------------------------
[tmc2208 stepper_z1]
uart_pin: PD4
interpolate: False
run_current: 0.4
sense_resistor: 0.110
#hold_current: 0.5
stealthchop_threshold: 999999
#--------------------------------------------------------------------
[tmc2208 stepper_z2]
uart_pin: PD0
interpolate: False
run_current: 0.4
#hold_current: 0.
sense_resistor: 0.110
stealthchop_threshold: 999999
#--------------------------------------------------------------------
[tmc2208 stepper_z3]
uart_pin: PD15
interpolate: False
run_current: 0.4
#hold_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 999999
#--------------------------------------------------------------------

#####################################################################
#   Extruder
#####################################################################

[extruder]
#step_pin:PB5
#dir_pin:PB4
#enable_pin:!PB6
step_pin: EBBCan: PD0
dir_pin: EBBCan: PD1
enable_pin: !EBBCan: PD2
microsteps: 32

##  Update value below when you perform extruder calibration
##  If you ask for 100mm of filament, but in reality it is 98mm:
##  rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100
##  22.6789511 is a good starting point
#rotation_distance: 22.0959333333	#Bondtech 5mm Drive Gears
rotation_distance: 21.89265074663
gear_ratio: 50:10
full_steps_per_rotation: 200	#200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.750
min_temp: -80
max_temp: 310
min_extrude_temp: 27
heater_pin: EBBCan: PB13
sensor_pin: EBBCan: PA3
#heater_pin: PB1
sensor_type:  Generic 3950
#sensor_pin: PC1
max_power: 1.0

## PID Tuning
#control : pid  
#pid_kp : 26.213 
#pid_ki : 1.304
#pid_kd : 131.721 

##  Try to keep pressure_advance below 1.0
#pressure_advance: 0.05 
pressure_advance: 0.07295
##  Default is 0.040, leave stock
pressure_advance_smooth_time: 0.040
max_extrude_only_distance: 100.0
max_extrude_cross_section: 5
## TMC UART configuration--------------------------------------------------------------------
[tmc2209 extruder]
#uart_pin: PB3
uart_pin: EBBCan: PA15
interpolate: False
run_current: 0.5
#hold_current: 0.5
sense_resistor: 0.110
stealthchop_threshold: 0
#--------------------------------------------------------------------



[heater_bed]
heater_pin: PB10
sensor_type: Generic 3950
sensor_pin: PC0

## PID Tuning
#control: pid
#pid_Kp: 42.066
#pid_Ki: 1.659
#pid_Kd: 266.595

max_power: 0.65
min_temp: 0
max_temp: 120

#####################################################################
# 	Probe
#####################################################################
[probe]
#pin:PB13
pin: ^!EBBCan:  PB6
x_offset: 0
y_offset: 0
#z_offset: 0
speed: 10.0
samples: 2
samples_result: median
sample_retract_dist: 3.0
samples_tolerance: 0.05
samples_tolerance_retries: 3

activate_gcode:
    {% set PROBE_TEMP = 170 %}
    {% set MAX_TEMP = PROBE_TEMP + 5 %}
    {% set ACTUAL_TEMP = printer.extruder.temperature %}
    {% set TARGET_TEMP = printer.extruder.target %}

    {% if TARGET_TEMP > PROBE_TEMP %}
        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
        M109 S{ PROBE_TEMP }
    {% else %}
        # Temperature target is already low enough, but nozzle may still be too hot.
        {% if ACTUAL_TEMP > MAX_TEMP %}
            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
        {% endif %}
    {% endif %} bed

#####################################################################
#	Save Config
#####################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 14.643
#*# pid_ki = 0.571
#*# pid_kd = 93.897
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 34.627
#*# pid_ki = 1.297
#*# pid_kd = 231.133
#*#
#*# [probe]
#*# z_offset = -2.035
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 39.8
#*# shaper_type_y = ei
#*# shaper_freq_y = 30.2
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.026250, -0.021250, -0.023750, -0.022500, -0.052500, -0.045000
#*# 	  -0.022500, -0.020000, -0.026250, -0.032500, -0.011250, -0.051250
#*# 	  -0.027500, -0.003750, -0.018750, -0.031250, -0.038750, -0.013750
#*# 	  -0.030000, -0.018750, -0.021250, -0.047500, -0.036250, -0.026250
#*# 	  -0.025000, -0.018750, -0.016250, -0.021250, -0.035000, -0.025000
#*# 	  0.002500, 0.008750, -0.013750, 0.008750, -0.006250, -0.030000
#*# x_count = 6
#*# y_count = 6
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 98.09
#*# max_x = 200.89
#*# min_y = 98.15
#*# max_y = 200.6
